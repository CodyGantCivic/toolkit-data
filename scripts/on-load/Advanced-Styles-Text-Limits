// ==UserScript==
// @name         CivicPlus - Widget Skin Helper
// @namespace    http://civicplus.com/
// @version      1.0.2
// @description  Advanced style helper for Widget Skins in Theme Manager
// @author       CivicPlus
// @match        *://*/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const TOOLKIT_NAME = '[CP Toolkit - Widget Skin Helper]';

    // Check if we're on the correct page (no jQuery needed)
    const pathname = window.location.pathname.toLowerCase();
    if (!pathname.includes('/designcenter/themes/')) {
        return;
    }

    console.log(TOOLKIT_NAME + ' Script loaded, waiting for page ready...');

    // Inject code into page context where page's jQuery is available
    const helperCode = `
        (function() {
            console.log('[CP Toolkit - Widget Skin Helper] Injected code running...');

            function checkValidBracket_ts(text) {
                if (text.indexOf("}") > text.indexOf("{") || ((text.indexOf("}") === -1) && (text.indexOf("{") !== -1))) {
                    alert("Invalid CSS detected. You appear to be using a { before using a }.");
                }
                var numLeftBracket = 0;
                var numRightBracket = 0;
                for (var i = 0; i < text.length; i++) {
                    if (text[i] === "}") numRightBracket++;
                    else if (text[i] === "{") numLeftBracket++;
                }
                var difference = Math.abs(numLeftBracket - numRightBracket);
                if (numLeftBracket > numRightBracket) {
                    alert("Invalid CSS. You have " + difference + " extra {.");
                } else if (numLeftBracket < numRightBracket) {
                    alert("Invalid CSS. You have " + difference + " extra }.");
                }
            }

            // Wait for both jQuery and initializePopovers
            function initHelper() {
                if (typeof window.$ === 'undefined' || typeof window.$.fn === 'undefined') {
                    console.log('[CP Toolkit - Widget Skin Helper] Waiting for jQuery...');
                    setTimeout(initHelper, 100);
                    return;
                }

                if (typeof window.initializePopovers === 'undefined') {
                    console.log('[CP Toolkit - Widget Skin Helper] Waiting for initializePopovers...');
                    setTimeout(initHelper, 100);
                    return;
                }

                console.log('[CP Toolkit - Widget Skin Helper] jQuery and initializePopovers found, hooking...');

                var originalInitializePopovers = window.initializePopovers;

                window.initializePopovers = function() {
                    console.log('[CP Toolkit - Widget Skin Helper] initializePopovers called');
                    originalInitializePopovers();

                    if ($(".cpPopOver #widgetSkinName").length) {
                        var skinId = $(".cpPopOver input#hdnSkinID").val();
                        if (skinId !== "-1") {
                            console.log("[CP Toolkit] Editing skin " + skinId);

                            setTimeout(function() {
                                var shouldBeFocused = $(".skin" + skinId + " .focused");
                                $(".focused").not(shouldBeFocused).removeClass("focused");
                            }, 500);

                            var textAreas = $(".cpPopOver [id*='MiscellaneousStyles']");
                            textAreas.each(function() {
                                var elem = this;
                                var existingEvents = $._data(elem, 'events');
                                var existingChangeFn = existingEvents && existingEvents.change && existingEvents.change[0] ? existingEvents.change[0].handler : null;

                                var text = $(elem).val();
                                text = text.replace(/.skin[0-9]+/g, ".skin" + skinId);
                                $(elem).val(text);

                                $(elem).change(function() {
                                    var originalText = $(this).text();
                                    var text = $(this).val().replace(/.skin[0-9]+/g, ".skin" + skinId);
                                    if (text !== originalText) {
                                        $(this).val(text);
                                        if (existingChangeFn) existingChangeFn.call(this);
                                    }
                                    checkValidBracket_ts(text);
                                });
                            });
                        } else {
                            console.log("[CP Toolkit] Editing new skin.");
                            var textAreas = $(".cpPopOver [id*='MiscellaneousStyles']");
                            textAreas.each(function() {
                                $(this).change(function() {
                                    var text = $(this).val();
                                    if (/.skin[0-9]+/g.test(text)) {
                                        alert("You used a skin number. Save the skin first to get a number.");
                                    }
                                    checkValidBracket_ts(text);
                                });
                            });
                        }
                    }
                };

                console.log("[CP Toolkit - Widget Skin Helper] Successfully loaded and hooked");
            }

            // Start initialization
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initHelper);
            } else {
                initHelper();
            }
        })();
    `;

    const script = document.createElement('script');
    script.textContent = helperCode;
    (document.head || document.documentElement).appendChild(script);
    script.remove();
})();
