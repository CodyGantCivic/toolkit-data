// @name         CP Toolkit - Remote Loader (multiple tools)
// @namespace    http://civicplus.com/
// @version      1.3.5
// @description  Detect CivicPlus site -> fetch & inject remote tools from GitHub and run them on the right pages (Layouts, Themes, ThemeManagerEnhancer, PreventSessionTimeout, widgetSkin helper, XML Major Change Alert).
// @match        *://*/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    const TOOL_NAME = '[CP Toolkit Loader]';

    // Remote raw URLs
    const DOWNLOAD_XML_CSS_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/DownloadXMLCSS.js';
    const ADVANCED_STYLES_HELPER_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/on-load/AdvancedStylesHelper.js';
    const WIDGET_SKIN_HELPER_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/on-load/widgetSkin-Helper.js';
    const THEME_MANAGER_ENHANCER_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/on-load/ThemeManagerEnhancer.js';
    const XML_MAJOR_CHANGE_ALERT_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/on-load/XMLMajorChangeAlert.js';
    const PREVENT_SESSION_TIMEOUT_URL = 'https://raw.githubusercontent.com/CodyGantCivic/toolkit-data/main/scripts/on-load/PreventSessionTimeout.js';

    // --- Prevent execution inside iframes (ads / trackers) ---
    if (window.top !== window.self) return;

    // Minimal registry for idempotency
    window.CPToolkit = window.CPToolkit || { injectedScripts: {} };

    // Expose CivicPlus detection to remote scripts
    window.CPToolkit.isCivicPlusSite = window.CPToolkit.isCivicPlusSite || isCivicPlusSite;

    // Page match helper (case-insensitive, supports simple globs)
    function pageMatches(patterns) {
        const url = window.location.href.toLowerCase();
        const pathname = window.location.pathname.toLowerCase();
        return patterns.some(pattern => {
            const norm = pattern.toLowerCase();
            const regex = new RegExp('^' + norm.replace(/\*/g, '.*') + '$', 'i');
            return regex.test(pathname) || regex.test(url);
        });
    }

    // CivicPlus detection (absolute)
    async function isCivicPlusSite() {
        const testUrl = `${window.location.origin}/Assets/Mystique/Shared/Components/ModuleTiles/Templates/cp-Module-Tile.html`;
        try {
            const resp = await fetch(testUrl, { method: 'HEAD', cache: 'no-store' });
            if (!resp) return false;
            if (resp.ok || resp.type === 'opaque') {
                console.log(TOOL_NAME, 'CivicPlus detected? true');
                return true;
            }
            if (resp.status === 405) {
                const r2 = await fetch(testUrl, { method: 'GET', cache: 'no-store' });
                if (r2 && (r2.ok || r2.type === 'opaque')) {
                    console.log(TOOL_NAME, 'CivicPlus detected? true');
                    return true;
                }
            }
            return false;
        } catch (e) {
            console.warn(TOOL_NAME, 'isCivicPlusSite check error:', e);
            return false;
        }
    }

    // Helper to produce a short readable name from URL
    function shortNameFromUrl(url) {
        try {
            const parts = url.split('/');
            const last = parts[parts.length - 1] || parts[parts.length - 2] || url;
            return decodeURIComponent(last).replace(/\?.*$/, '');
        } catch (e) {
            return url;
        }
    }

    // Fetch and inject script (minimal logging)
    async function fetchAndInjectScript(url) {
        // Idempotent guard
        if (window.CPToolkit.injectedScripts[url] || document.querySelector(`script[data-cp-tool-url="${url}"]`)) {
            return true;
        }

        const shortName = shortNameFromUrl(url);
        // Single activation log when starting this script
        console.log(TOOL_NAME, 'Activating', shortName);

        try {
            const r = await fetch(url, { cache: 'no-store' });
            if (!r.ok) {
                console.warn(TOOL_NAME, 'Fetch failed for', shortName, r.status);
                return false;
            }
            const text = await r.text();
            if (!text || !text.trim()) {
                console.warn(TOOL_NAME, 'Empty script content for', shortName);
                return false;
            }

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.setAttribute('data-cp-tool-url', url);
            script.textContent = `${text}\n//# sourceURL=${url}\n`;
            (document.head || document.documentElement).appendChild(script);

            window.CPToolkit.injectedScripts[url] = true;
            return true;
        } catch (err) {
            console.warn(TOOL_NAME, 'Failed to fetch/inject', shortName, err);
            return false;
        }
    }

    // Wait for a global (used only when calling exports). No logging here.
    function waitForGlobal(name, timeout = 4000, interval = 150) {
        return new Promise((resolve) => {
            let waited = 0;
            const t = setInterval(() => {
                const parts = name.split('.');
                let cur = window;
                for (let p of parts) {
                    if (!cur) break;
                    cur = cur[p];
                }
                if (typeof cur === 'function' || (typeof cur === 'object' && cur && typeof cur.init === 'function')) {
                    clearInterval(t);
                    resolve(cur);
                    return;
                }
                waited += interval;
                if (waited >= timeout) {
                    clearInterval(t);
                    resolve(null);
                }
            }, interval);
        });
    }

    // Try to find an export and call it (silent on success apart from activation earlier)
    async function findAndCallAny(candidates = [], callArgs = []) {
        for (const name of candidates) {
            const sanitized = String(name).replace(/^window\./i, '');
            const val = await waitForGlobal(sanitized, 2000);
            if (val) {
                try {
                    if (typeof val === 'function') {
                        val.apply(null, callArgs);
                    } else if (typeof val === 'object' && typeof val.init === 'function') {
                        val.init.apply(val, callArgs);
                    }
                    return true;
                } catch (err) {
                    console.warn(TOOL_NAME, `Exported callable threw for ${sanitized}`, err);
                    return false;
                }
            }
        }
        return false;
    }

    // Main loader flow (minimal console)
    (async function runLoader() {
        try {
            const isCP = await isCivicPlusSite();
            if (!isCP) return;

            // Inject core scripts
            await fetchAndInjectScript(DOWNLOAD_XML_CSS_URL).catch(()=>{});
            await fetchAndInjectScript(ADVANCED_STYLES_HELPER_URL).catch(()=>{});
            await fetchAndInjectScript(WIDGET_SKIN_HELPER_URL).catch(()=>{});

            // Theme Manager Enhancer on DesignCenter pages
            if (pageMatches(['/designcenter/themes*', '/designcenter/widgets*', '/designcenter/animations*'])) {
                await fetchAndInjectScript(THEME_MANAGER_ENHANCER_URL).catch(()=>{});
                await findAndCallAny(['ThemeManagerEnhancer', 'ThemeManagerEnhancer.init'], []);
            }

            // Prevent Session Timeout on admin pages
            if (pageMatches(['/admin/*', '/Admin/*', '/designcenter/*', '/DesignCenter/*'])) {
                await fetchAndInjectScript(PREVENT_SESSION_TIMEOUT_URL).catch(()=>{});
                await findAndCallAny(['PreventSessionTimeout', 'PreventSessionTimeout.init'], []);
            }

            // XML Major Change Alert on Layout Modify page
            if (pageMatches(['/admin/designcenter/layouts/modify*', '/Admin/DesignCenter/Layouts/Modify*'])) {
                await fetchAndInjectScript(XML_MAJOR_CHANGE_ALERT_URL).catch(()=>{});
                await findAndCallAny(['XMLMajorChangeAlert', 'XMLMajorChangeAlert.init'], []);
            }

            // Layouts page exported calls
            if (pageMatches(['/admin/designcenter/layouts*', '/Admin/DesignCenter/Layouts*'])) {
                await findAndCallAny(['downloadxmlcss', 'DownloadXMLCSS', 'insertDownloadButtons'], []);
            }

            // Themes page exported calls
            if (pageMatches(['/DesignCenter/Themes*', '/designcenter/themes*'])) {
                await findAndCallAny(['enforceAdvancedStyles', 'widgetSkinHelper'], []);
            }
        } catch (err) {
            console.error(TOOL_NAME, 'Loader error', err);
        }
    })();

    // SPA support: re-run minimal decisions on URL change (only logs when activation starts)
    (function enableSpaNavigationRerun() {
        const originalPush = history.pushState;
        const originalReplace = history.replaceState;
        function notifyUrlChange() {
            try {
                if (window.__cpToolkitRerunTimer) clearTimeout(window.__cpToolkitRerunTimer);
                window.__cpToolkitRerunTimer = setTimeout(() => {
                    (async () => {
                        try {
                            const isCP = await isCivicPlusSite();
                            if (!isCP) return;

                            if (pageMatches(['/designcenter/themes*', '/designcenter/widgets*', '/designcenter/animations*'])) {
                                await fetchAndInjectScript(THEME_MANAGER_ENHANCER_URL).catch(()=>{});
                                await findAndCallAny(['ThemeManagerEnhancer', 'ThemeManagerEnhancer.init'], []);
                            }

                            if (pageMatches(['/admin/*', '/Admin/*', '/designcenter/*'])) {
                                await fetchAndInjectScript(PREVENT_SESSION_TIMEOUT_URL).catch(()=>{});
                                await findAndCallAny(['PreventSessionTimeout', 'PreventSessionTimeout.init'], []);
                            }

                            if (pageMatches(['/admin/designcenter/layouts/modify*'])) {
                                await fetchAndInjectScript(XML_MAJOR_CHANGE_ALERT_URL).catch(()=>{});
                                await findAndCallAny(['XMLMajorChangeAlert', 'XMLMajorChangeAlert.init'], []);
                            }

                            if (pageMatches(['/admin/designcenter/layouts*'])) {
                                await findAndCallAny(['downloadxmlcss', 'DownloadXMLCSS', 'insertDownloadButtons'], []);
                            }

                            if (pageMatches(['/designcenter/themes*'])) {
                                await findAndCallAny(['enforceAdvancedStyles', 'widgetSkinHelper'], []);
                            }
                        } catch (e) {
                            console.warn(TOOL_NAME, 'SPA rerun error:', e);
                        }
                    })();
                }, 200);
            } catch (e) {
                console.warn(TOOL_NAME, 'notifyUrlChange error', e);
            }
        }
        history.pushState = function() {
            const result = originalPush.apply(this, arguments);
            notifyUrlChange();
            return result;
        };
        history.replaceState = function() {
            const result = originalReplace.apply(this, arguments);
            notifyUrlChange();
            return result;
        };
        window.addEventListener('popstate', notifyUrlChange);
    })();

})();
